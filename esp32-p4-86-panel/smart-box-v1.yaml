# ==============================================================================
# ESP32-P4 Smart 86-Box Configuration
# ==============================================================================
# This configuration file is for the ESP32-P4 Smart 86-Box device.
# It includes configuration for the display, touch controller, audio, voice assistant,
# and integration with Home Assistant.
#
# KEY CONFIGURATION AREAS:
# 1. Substitutions: Set device name, WiFi, and Home Assistant entities (Lines 1-84)
# 2. WiFi: Credentials are in secrets.yaml
# 3. Home Assistant: Requires specific helper sensors to be created in HA
#
# ==============================================================================

substitutions:
  # -------------------------------------------------------------------------
  # DEVICE IDENTITY
  # -------------------------------------------------------------------------
  # The name used for the ESPHome device ID (must be lowercase, no spaces)
  name: smart-box-v1
  # The friendly name shown in Home Assistant and the ESPHome dashboard
  friendly_name: "Smart Box V1"

  # Hardware pin mappings for ESP32-P4 Smart 86-Box
  # I2C Bus (shared by touch, audio DAC, and audio ADC)
  i2c_sda_pin: "7"
  i2c_scl_pin: "8"

  # I2S Audio Bus
  i2s_mclk_pin: "13" # Master Clock
  i2s_lrclk_pin: "10" # Left/Right Clock (Word Select)
  i2s_bclk_pin: "12" # Bit Clock
  i2s_din_pin: "11" # Data In (Microphone)
  i2s_dout_pin: "9" # Data Out (Speaker)

  # WiFi Co-Processor (ESP32-C6)
  wifi_reset_pin: "54"
  wifi_cmd_pin: "19"
  wifi_clk_pin: "18"
  wifi_d0_pin: "14"
  wifi_d1_pin: "15"
  wifi_d2_pin: "16"
  wifi_d3_pin: "17"

  # Display and Power
  backlight_pin: "26"
  audio_amp_pin: "53"

  # Voice assistant phase IDs
  voice_assist_idle_phase_id: "1"
  voice_assist_listening_phase_id: "2"
  voice_assist_thinking_phase_id: "3"
  voice_assist_replying_phase_id: "4"
  voice_assist_not_ready_phase_id: "10"
  voice_assist_error_phase_id: "11"
  voice_assist_muted_phase_id: "12"

  # -------------------------------------------------------------------------
  # WEATHER CONFIGURATION
  # -------------------------------------------------------------------------
  # The Home Assistant weather entity to use for current conditions
  # Go to Developer Tools -> States in Home Assistant to find your entity ID
  weather_entity: "weather.forecast" # Example: weather.home or weather.forecast_home

  # Weather forecast template sensors
  # IMPORTANT: These sensors do NOT exist by default in Home Assistant.
  # You must create them in your Home Assistant configuration.yaml using templates
  # that extract data from your weather entity.
  # See the project documentation for the required template sensor configuration.
  weather_forecast_today_temp_high: "sensor.weather_forecast_today_temp_high"
  weather_forecast_today_temp_low: "sensor.weather_forecast_today_temp_low"
  weather_forecast_temp_high: "sensor.weather_forecast_tomorrow_temp_high"
  weather_forecast_temp_low: "sensor.weather_forecast_tomorrow_temp_low"
  weather_forecast_condition: "sensor.weather_forecast_tomorrow_condition"
  weather_forecast_after_tomorrow_temp_high: "sensor.weather_forecast_after_tomorrow_temp_high"
  weather_forecast_after_tomorrow_temp_low: "sensor.weather_forecast_after_tomorrow_temp_low"
  weather_forecast_after_tomorrow_condition: "sensor.weather_forecast_after_tomorrow_condition"

  # -------------------------------------------------------------------------
  # MEDIA PLAYER CONFIGURATION
  # -------------------------------------------------------------------------
  # The Home Assistant media player entity to control (e.g., a Sonos, MPD, or this device itself)
  # This entity will be controlled by the play/pause/next/prev buttons and volume slider
  default_media_player: "media_player.media_player"

  # Album art sensor (create this in Home Assistant configuration.yaml)
  # This sensor extracts the album art URL from the media player
  now_playing_album_art: "sensor.now_playing_album_art"

  # -------------------------------------------------------------------------
  # RADIO & PLAYLIST PRESETS
  # -------------------------------------------------------------------------
  # Configuration for the Music tab presets
  
  # Content types for your media player (usually 'music', 'channel', or 'playlist')
  album_radio_content_type: "channel"
  playlist_content_type: "playlist"

  # Unified Radio Stations (1-3)
  radio_1_content_id: "library://radio/1"
  radio_1_name: "Radio 1"
  radio_2_content_id: "library://radio/2"
  radio_2_name: "Radio 2"
  radio_3_content_id: "library://radio/3"
  radio_3_name: "Radio 3"

  # Unified Playlists (1-3)
  playlist_1_content_id: "library://playlist/1"
  playlist_1_name: "Playlist 1"
  playlist_2_content_id: "library://playlist/2"
  playlist_2_name: "Playlist 2"
  playlist_3_content_id: "library://playlist/3"
  playlist_3_name: "Playlist 3"

  # -------------------------------------------------------------------------
  # PHYSICAL BUTTON MAPPING
  # -------------------------------------------------------------------------
  # Map the 4 physical buttons on the device to Home Assistant entities
  # These can be lights, switches, scripts, or any toggleable entity
  button_1_entity: "light.button_1"
  button_2_entity: "light.button_2"
  button_3_entity: "light.button_3"
  button_4_entity: "light.button_4"

esphome:
  name: ${name}
  friendly_name: ${friendly_name}
  min_version: 2025.8.0
  name_add_mac_suffix: false
  on_boot:
    priority: 600
    then:
      - script.execute: draw_display
      - script.execute: update_weather_dates
      - delay: 30s
      - if:
          condition:
            lambda: return id(init_in_progress);
          then:
            - lambda: id(init_in_progress) = false;
            - script.execute: draw_display

esp32:
  board: esp32-p4-evboard
  flash_size: 32MB
  cpu_frequency: 400MHz
  framework:
    type: esp-idf
    version: 5.4.2
    platform_version: https://github.com/pioarduino/platform-espressif32/releases/download/54.03.21/platform-espressif32.zip
    advanced:
      enable_idf_experimental_features: yes

logger:
  level: INFO
  hardware_uart: UART0
  logs:
    # Set to DEBUG or VERBOSE for more detailed output, but it may affect performance
    lvgl: INFO

psram:
  speed: 200MHz

# LDO voltage regulator configuration (required for ESP32-P4)
esp_ldo:
  - channel: 3
    voltage: 2.5V

api:
  on_client_connected:
    - script.execute: draw_display
    - script.execute: update_weather_dates
  on_client_disconnected:
    - script.execute: draw_display

ota:
  - platform: esphome

# WiFi configuration using ESP32-C6 co-processor
esp32_hosted:
  active_high: true
  variant: ESP32C6
  reset_pin: GPIO${wifi_reset_pin}
  cmd_pin: GPIO${wifi_cmd_pin}
  clk_pin: GPIO${wifi_clk_pin}
  d0_pin: GPIO${wifi_d0_pin}
  d1_pin: GPIO${wifi_d1_pin}
  d2_pin: GPIO${wifi_d2_pin}
  d3_pin: GPIO${wifi_d3_pin}

wifi:
  # WiFi credentials are loaded from secrets.yaml
  # Ensure you have a secrets.yaml file with 'wifi_ssid' and 'wifi_password' defined
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "Smart Box V1 Hotspot"
    password: "SmartBoxV1"
  on_connect:
    - script.execute: draw_display
  on_disconnect:
    - script.execute: draw_display

http_request:
  # Important for online_image: default timeout might be too short for large images
  timeout: 10s

captive_portal:

# I2C Bus - shared by GT911 touch, ES8311 DAC, and ES7210 ADC
i2c:
  sda: GPIO${i2c_sda_pin}
  scl: GPIO${i2c_scl_pin}
  scan: true
  frequency: 400kHz
  id: i2c_bus

# I2S Audio Bus
i2s_audio:
  - id: audio_bus
    i2s_mclk_pin: GPIO${i2s_mclk_pin}
    i2s_lrclk_pin: GPIO${i2s_lrclk_pin}
    i2s_bclk_pin: GPIO${i2s_bclk_pin}

# Audio DAC (ES8311)
audio_dac:
  - platform: es8311
    id: es8311_dac
    i2c_id: i2c_bus
    address: 0x18
    bits_per_sample: 16bit
    sample_rate: 16000

# Audio ADC (ES7210) for microphones
audio_adc:
  - platform: es7210
    id: es7210_adc
    i2c_id: i2c_bus
    address: 0x40

# Microphone
microphone:
  - platform: i2s_audio
    id: esp32_microphone
    i2s_audio_id: audio_bus
    i2s_din_pin: GPIO${i2s_din_pin}
    sample_rate: 16000
    bits_per_sample: 16bit
    adc_type: external
    channel: left

# Speaker
speaker:
  - platform: i2s_audio
    id: esp32_speaker
    i2s_audio_id: audio_bus
    i2s_dout_pin: GPIO${i2s_dout_pin}
    audio_dac: es8311_dac
    dac_type: external
    channel: left
    sample_rate: 16000
    bits_per_sample: 16bit
    buffer_duration: 500ms

# Media Player
media_player:
  - platform: speaker
    name: "Media Player"
    id: external_media_player
    announcement_pipeline:
      speaker: esp32_speaker
      format: FLAC
      sample_rate: 16000
      num_channels: 1
    on_announcement:
      - if:
          condition:
            - microphone.is_capturing:
          then:
            - script.execute: stop_wake_word
      - switch.turn_on: audio_amplifier
      - delay: 100ms
    on_idle:
      - if:
          condition:
            and:
              - not:
                  voice_assistant.is_running:
              - lambda: return id(voice_assistant_phase) != ${voice_assist_idle_phase_id} && id(voice_assistant_phase) != ${voice_assist_muted_phase_id};
          then:
            - script.execute: start_wake_word
            - script.execute: set_idle_or_mute_phase
            - script.execute: draw_display
      - delay: 100ms
      - switch.turn_off: audio_amplifier

# Micro Wake Word
micro_wake_word:
  id: mww
  # Wake word models to use. You can add or remove models here.
  # Available models depend on what is installed/compiled.
  models:
    - okay_nabu
    - hey_jarvis
    - alexa
  on_wake_word_detected:
    - voice_assistant.start:
        wake_word: !lambda return wake_word;

# Voice Assistant
voice_assistant:
  id: va
  microphone: esp32_microphone
  media_player: external_media_player
  micro_wake_word: mww
  # Audio processing settings - adjust if voice detection is poor
  noise_suppression_level: 2
  auto_gain: 31dBFS
  volume_multiplier: 2.0
  on_listening:
    - lambda: id(voice_assistant_phase) = ${voice_assist_listening_phase_id};
    - script.execute: draw_display
  on_stt_vad_end:
    - lambda: id(voice_assistant_phase) = ${voice_assist_thinking_phase_id};
    - script.execute: draw_display
  on_tts_start:
    - lambda: id(voice_assistant_phase) = ${voice_assist_replying_phase_id};
    - script.execute: draw_display
  on_end:
    - wait_until:
        condition:
          - media_player.is_announcing:
        timeout: 2.0s
    - wait_until:
        - and:
            - not:
                media_player.is_announcing:
            - not:
                speaker.is_playing:
    - delay: 1s
    - if:
        condition:
          - lambda: return id(wake_word_engine_location).state == "On device";
        then:
          - lambda: id(va).set_use_wake_word(false);
          - micro_wake_word.start:
    - script.execute: set_idle_or_mute_phase
    - script.execute: draw_display
  on_error:
    - if:
        condition:
          lambda: return !id(init_in_progress);
        then:
          - lambda: id(voice_assistant_phase) = ${voice_assist_error_phase_id};
          - script.execute: draw_display
          - delay: 1s
          - if:
              condition:
                switch.is_off: mute
              then:
                - lambda: id(voice_assistant_phase) = ${voice_assist_idle_phase_id};
              else:
                - lambda: id(voice_assistant_phase) = ${voice_assist_muted_phase_id};
          - script.execute: draw_display
  on_client_connected:
    - lambda: id(init_in_progress) = false;
    - script.execute: start_wake_word
    - script.execute: set_idle_or_mute_phase
    - script.execute: draw_display
  on_client_disconnected:
    - script.execute: stop_wake_word
    - lambda: id(voice_assistant_phase) = ${voice_assist_not_ready_phase_id};
    - script.execute: draw_display

# Button state tracking
binary_sensor:
  - platform: homeassistant
    id: button_1_state
    entity_id: ${button_1_entity}
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: button_1_state
            then:
              - lvgl.widget.update:
                  id: button_1
                  bg_color: 0xFFD700 # Active Color (Yellow)
            else:
              - lvgl.widget.update:
                  id: button_1
                  bg_color: 0x1a1a1a # Inactive Color

  - platform: homeassistant
    id: button_2_state
    entity_id: ${button_2_entity}
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: button_2_state
            then:
              - lvgl.widget.update:
                  id: button_2
                  bg_color: 0xFFD700 # Active Color (Yellow)
            else:
              - lvgl.widget.update:
                  id: button_2
                  bg_color: 0x1a1a1a # Inactive Color

  - platform: homeassistant
    id: button_3_state
    entity_id: ${button_3_entity}
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: button_3_state
            then:
              - lvgl.widget.update:
                  id: button_3
                  bg_color: 0xFFD700 # Active Color (Yellow)
            else:
              - lvgl.widget.update:
                  id: button_3
                  bg_color: 0x1a1a1a # Inactive Color

  - platform: homeassistant
    id: button_4_state
    entity_id: ${button_4_entity}
    on_state:
      then:
        - if:
            condition:
              binary_sensor.is_on: button_4_state
            then:
              - lvgl.widget.update:
                  id: button_4
                  bg_color: 0xFFD700 # Active Color (Yellow)
            else:
              - lvgl.widget.update:
                  id: button_4
                  bg_color: 0x1a1a1a # Inactive Color

# Time from Home Assistant
time:
  - platform: homeassistant
    id: ha_time
    on_time:
      - seconds: 0
        minutes: 0
        then:
          - script.execute: update_weather_dates

# Weather and sensor data from Home Assistant
sensor:

  # Current temperature from weather entity
  - platform: homeassistant
    id: ha_weather_temperature
    entity_id: ${weather_entity}
    attribute: temperature
    on_value:
      - lvgl.label.update:
          id: current_temp
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);
      - lvgl.label.update:
          id: current_temp_music
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);
      - lvgl.label.update:
          id: current_temp_home
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);

  # Wind speed from weather entity
  - platform: homeassistant
    id: ha_weather_wind_speed
    entity_id: ${weather_entity}
    attribute: wind_speed
    on_value:
      - lvgl.label.update:
          id: wind_value
          text: !lambda |-
            if (isnan(x)) {
              return std::string("-- m/s");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.1f m/s", x);
            return std::string(buf);

  # Humidity from weather entity
  - platform: homeassistant
    id: ha_weather_humidity
    entity_id: ${weather_entity}
    attribute: humidity
    on_value:
      - lvgl.label.update:
          id: humidity_value
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--%");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f%%", x);
            return std::string(buf);

  # Today's forecast high temperature
  - platform: homeassistant
    id: ha_weather_today_temp_high
    entity_id: ${weather_forecast_today_temp_high}
    on_value:
      - lvgl.label.update:
          id: highest_value
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);
      - lvgl.label.update:
          id: current_temp_weather
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);

  # Today's forecast low temperature
  - platform: homeassistant
    id: ha_weather_today_temp_low
    entity_id: ${weather_forecast_today_temp_low}
    on_value:
      - lvgl.label.update:
          id: lowest_value
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);

  # Tomorrow's forecast high temperature
  - platform: homeassistant
    id: ha_weather_forecast_temp_high
    entity_id: ${weather_forecast_temp_high}
    on_value:
      - lvgl.label.update:
          id: tomorrow_temp
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);

  # Tomorrow's forecast low temperature
  - platform: homeassistant
    id: ha_weather_forecast_temp_low
    entity_id: ${weather_forecast_temp_low}
    # Note: Tomorrow's low temperature is tracked but not currently displayed on the UI

  # Day after tomorrow's forecast high temperature
  - platform: homeassistant
    id: ha_weather_forecast_after_tomorrow_temp_high
    entity_id: ${weather_forecast_after_tomorrow_temp_high}
    on_value:
      - lvgl.label.update:
          id: after_tomorrow_temp
          text: !lambda |-
            if (isnan(x)) {
              return std::string("--°");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%.0f°", x);
            return std::string(buf);

  # Day after tomorrow's forecast low temperature
  - platform: homeassistant
    id: ha_weather_forecast_after_tomorrow_temp_low
    entity_id: ${weather_forecast_after_tomorrow_temp_low}

  # Media player volume tracking
  # Local media player volume tracking (more responsive than HA sensor)
  - platform: template
    id: media_player_volume
    internal: true
    update_interval: 200ms
    lambda: |-
      return id(external_media_player).volume;
    on_value:
      - if:
          condition:
            lambda: |-
              // Only update if not initializing and not currently dragging the slider
              return !id(init_in_progress) && !id(ignore_swipe);
          then:
            - lvgl.slider.update:
                id: slider_volume
                value: !lambda "return x * 100;"

# Weather condition and media player text sensors
text_sensor:
  # Media player state tracking
  - platform: homeassistant
    id: media_player_state
    entity_id: ${default_media_player}
    on_value:
      - lambda: |-
          // Update play/pause button based on state
          std::string state = x;
          ESP_LOGI("media_player", "State changed to: %s", state.c_str());
          if (state == "playing") {
            id(is_playing) = true;
          } else {
            id(is_playing) = false;
          }
          // Reset radio mode if player is stopped or idle
          if (state == "idle" || state == "off") {
             id(active_radio_station) = 0;
             id(update_album_art_display)->execute();
          }
      - if:
          condition:
            lambda: "return id(is_playing);"
          then:
            - lvgl.label.update:
                id: pause_button_label
                text: "\U000F03E4" # mdi:pause
            - lvgl.label.update:
                id: pause_button_music_label
                text: "\U000F03E4" # mdi:pause
            - lvgl.label.update:
                id: pause_button_home_label
                text: "\U000F03E4" # mdi:pause
          else:
            - lvgl.label.update:
                id: pause_button_label
                text: "\U000F040A" # mdi:play
            - lvgl.label.update:
                id: pause_button_music_label
                text: "\U000F040A" # mdi:play
            - lvgl.label.update:
                id: pause_button_home_label
                text: "\U000F040A" # mdi:play

  # Media Content ID Sensor - CRITICAL for detecting changes made on Phone/HA
  - platform: homeassistant
    id: media_player_content_id
    entity_id: ${default_media_player}
    attribute: media_content_id
    on_value:
      - lambda: |-
          // Identify if the current content matches a known radio station
          std::string content = x;
          int new_station = 0;

          // Match against defined radio IDs
          if (content == "${radio_1_content_id}") new_station = 1;
          else if (content == "${radio_2_content_id}") new_station = 2;
          else if (content == "${radio_3_content_id}") new_station = 3;
          else if (content == "${playlist_1_content_id}") new_station = 4;
          else if (content == "${playlist_2_content_id}") new_station = 5;
          else if (content == "${playlist_3_content_id}") new_station = 6;

          // Update global state and refresh display
          id(active_radio_station) = new_station;
          ESP_LOGI("radio_detect", "Content changed to '%s', detected station %d", content.c_str(), new_station);
          id(update_album_art_display)->execute();

  # Media player title tracking
  - platform: homeassistant
    id: media_player_title
    entity_id: ${default_media_player}
    attribute: media_title
    on_value:
      - lvgl.label.update:
          id: music_title
          text: !lambda |-
            if (x.empty() || x == "unknown") {
              return std::string("No Media");
            }
            return x;

  # Media player artist tracking
  - platform: homeassistant
    id: media_player_artist
    entity_id: ${default_media_player}
    attribute: media_artist
    on_value:
      - lvgl.label.update:
          id: music_artist
          text: !lambda |-
            if (x.empty() || x == "unknown") {
              return std::string("");
            }
            return x;

  # Now Playing Album Art URL (from Home Assistant template sensor)
  - platform: homeassistant
    id: media_player_album_art
    entity_id: ${now_playing_album_art}
    on_value:
      - lambda: |-
          std::string url = x;
          ESP_LOGI("album_art", "Album art URL updated: %s", url.c_str());

          // Update the online image with the new URL (always keep component updated)
          if (!url.empty() && url != "unknown") {
            id(album_art_online).set_url(url.c_str());
            id(album_art_online).update();
            id(album_art_online_full).set_url(url.c_str());
            id(album_art_online_full).update();
          }

  # Current weather condition
  - platform: homeassistant
    id: ha_weather_condition
    entity_id: ${weather_entity}
    on_value:
      - lvgl.image.update:
          id: current_weather_icon
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to sunny for unknown conditions
              return id(weather_sunny);
            }
      - lvgl.image.update:
          id: current_weather_icon_music
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to sunny for unknown conditions
              return id(weather_sunny);
            }
      - lvgl.image.update:
          id: todays_weather_icon
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to sunny for unknown conditions
              return id(weather_sunny);
            }
      - lvgl.image.update:
          id: current_weather_icon_home
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to sunny for unknown conditions
              return id(weather_sunny);
            }

  # Tomorrow's forecast condition
  - platform: homeassistant
    id: ha_weather_forecast_condition
    entity_id: ${weather_forecast_condition}
    on_value:
      - lvgl.image.update:
          id: tomorrows_weather_icon
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to cloudy for unknown conditions
              return id(weather_cloudy);
            }

  # Day after tomorrow's forecast condition
  - platform: homeassistant
    id: ha_weather_forecast_after_tomorrow_condition
    entity_id: ${weather_forecast_after_tomorrow_condition}
    on_value:
      - lvgl.image.update:
          id: after_tomorrows_weather_icon
          src: !lambda |-
            std::string condition = x;

            if (condition == "sunny") {
              return id(weather_sunny);
            } else if (condition == "clear-night") {
              return id(weather_clear_night);
            } else if (condition == "cloudy") {
              return id(weather_cloudy);
            } else if (condition == "fog") {
              return id(weather_fog);
            } else if (condition == "hail") {
              return id(weather_hail);
            } else if (condition == "lightning") {
              return id(weather_lightning);
            } else if (condition == "lightning-rainy") {
              return id(weather_lightning_rainy);
            } else if (condition == "partlycloudy") {
              return id(weather_partlycloudyday);
            } else if (condition == "pouring") {
              return id(weather_pouring);
            } else if (condition == "rainy") {
              return id(weather_rainy);
            } else if (condition == "snowy") {
              return id(weather_snowy);
            } else if (condition == "snowy-rainy") {
              return id(weather_snowy_rainy);
            } else if (condition == "windy") {
              return id(weather_windy);
            } else if (condition == "windy-variant") {
              return id(weather_windy_variant);
            } else if (condition == "exceptional") {
              return id(weather_exceptional);
            } else {
              // Default to cloudy for unknown conditions
              return id(weather_cloudy);
            }

# Restart Button
button:
  - platform: restart
    id: restart_button
    name: "Restart Device"

# Backlight Control
output:
  - platform: ledc
    id: backlight_output
    pin: GPIO${backlight_pin}
    frequency: 100Hz
    inverted: true

light:
  - platform: monochromatic
    id: backlight_light
    name: "Backlight"
    output: backlight_output
    restore_mode: RESTORE_DEFAULT_ON
    default_transition_length: 250ms
    on_state:
      - if:
          condition:
            lambda: return !id(init_in_progress) && !id(ignore_swipe);
          then:
            - lvgl.slider.update:
                id: slider_brightness
                value: !lambda "return id(backlight_light).remote_values.get_brightness() * 100;"

# Audio Amplifier Control
switch:
  - platform: gpio
    pin: GPIO${audio_amp_pin}
    name: "Audio Amplifier"
    id: audio_amplifier
    restore_mode: ALWAYS_OFF
    internal: true

  - platform: template
    name: "Mute"
    id: mute
    icon: "mdi:microphone-off"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_OFF
    entity_category: config
    on_turn_off:
      - microphone.unmute:
      - lambda: id(voice_assistant_phase) = ${voice_assist_idle_phase_id};
      - script.execute: draw_display
    on_turn_on:
      - microphone.mute:
      - lambda: id(voice_assistant_phase) = ${voice_assist_muted_phase_id};
      - script.execute: draw_display

select:
  - platform: template
    entity_category: config
    name: "Wake word engine location"
    id: wake_word_engine_location
    icon: "mdi:account-voice"
    optimistic: true
    restore_value: true
    options:
      - In Home Assistant
      - On device
    initial_option: On device
    on_value:
      - if:
          condition:
            lambda: return !id(init_in_progress);
          then:
            - wait_until:
                lambda: return id(voice_assistant_phase) == ${voice_assist_muted_phase_id} || id(voice_assistant_phase) == ${voice_assist_idle_phase_id};
            - if:
                condition:
                  lambda: return x == "In Home Assistant";
                then:
                  - micro_wake_word.stop
                  - delay: 500ms
                  - if:
                      condition:
                        switch.is_off: mute
                      then:
                        - lambda: id(va).set_use_wake_word(true);
                        - voice_assistant.start_continuous:
            - if:
                condition:
                  lambda: return x == "On device";
                then:
                  - lambda: id(va).set_use_wake_word(false);
                  - voice_assistant.stop
                  - delay: 500ms
                  - if:
                      condition:
                        switch.is_off: mute
                      then:
                        - micro_wake_word.start

# Display Configuration - MIPI-DSI 720x720
# Proper configuration based on reference implementation
display:
  - platform: mipi_dsi
    model: WAVESHARE-P4-86-PANEL
    id: main_display
    auto_clear_enabled: false
    reset_pin:
      number: 27
      inverted: false

# GT911 Touch Controller with swipe gesture detection
touchscreen:
  - platform: gt911
    id: touchscreen_controller
    on_touch:
      - lambda: |-
          ESP_LOGI("touch", "Touch at x=%d, y=%d", touch.x, touch.y);
          // Store touch start position for swipe detection if not ignored
          if (!id(ignore_swipe)) {
            id(touch_start_x) = touch.x;
            id(touch_start_y) = touch.y;
            id(swipe_in_progress) = true;
          }
    on_release:
      - lambda: |-
          id(was_swipe) = false;
          // Detect swipe gesture on release
          if (!id(ignore_swipe) && id(swipe_in_progress) && id(voice_assistant_phase) == ${voice_assist_idle_phase_id}) {
            auto touch_point = id(touchscreen_controller).get_touch();
            if (touch_point.has_value()) {
              int end_x = touch_point.value().x;
              int end_y = touch_point.value().y;
              int delta_x = end_x - id(touch_start_x);
              int delta_y = end_y - id(touch_start_y);
              
              // Horizontal swipe threshold (100 pixels minimum)
              if (abs(delta_x) > 100 && abs(delta_x) > abs(delta_y) * 2) {
                id(was_swipe) = true;
                if (!id(is_settings_open)) {
                  if (delta_x < 0) {
                    // Swipe LEFT - go to next screen (0 -> 1 -> 2 -> 0)
                    id(current_screen_index) = (id(current_screen_index) + 1) % 3;
                    ESP_LOGI("swipe", "Swipe LEFT detected, switching to screen %d", id(current_screen_index));
                  } else {
                    // Swipe RIGHT - go to previous screen (0 -> 2 -> 1 -> 0)
                    if (id(current_screen_index) == 0) {
                      id(current_screen_index) = 2;
                    } else {
                      id(current_screen_index) = id(current_screen_index) - 1;
                    }
                    ESP_LOGI("swipe", "Swipe RIGHT detected, switching to screen %d", id(current_screen_index));
                  }
                  // Navigate to the new screen
                  id(navigate_to_screen)->execute();
                }
              }
              
              // Vertical swipe threshold
              if (abs(delta_y) > 100 && abs(delta_y) > abs(delta_x) * 2) {
                id(was_swipe) = true;
                if (delta_y > 0) {
                  // Swipe DOWN - Open Settings
                  if (!id(is_settings_open)) {
                     id(is_settings_open) = true;
                     id(previous_screen_index) = id(current_screen_index);
                     ESP_LOGI("swipe", "Swipe DOWN detected, opening Settings");
                     id(open_settings)->execute();
                     // Note: using direct lambda call to show page if action not available in lambda easily
                     // But we can use id(settings_page).show() if wrapper exists?
                     // Or just use a script?
                     // Let's use a script for safety or just assume standard action works in lambda?
                     // Standard action `lvgl.page.show` is not available in C++ lambda directly.
                     // We need to use a script or call the C++ method.
                     // id(settings_page)->make_visible(); ?
                     // Let's use a script `open_settings` and `close_settings`.
                  }
                } else {
                  // Swipe UP - Close Settings
                  if (id(is_settings_open)) {
                     id(is_settings_open) = false;
                     ESP_LOGI("swipe", "Swipe UP detected, closing Settings");
                     id(navigate_to_screen)->execute();
                  }
                }
              }
            }
          }
          id(swipe_in_progress) = false;

# Scripts
script:
  - id: open_settings
    then:
      - lambda: id(ignore_swipe) = false;
      - lvgl.page.show: settings_page

  - id: draw_display
    then:
      - if:
          condition:
            lambda: return !id(init_in_progress);
          then:
            - if:
                condition:
                  wifi.connected:
                then:
                  - if:
                      condition:
                        api.connected:
                      then:
                        - if:
                            condition:
                              lambda: return id(voice_assistant_phase) == ${voice_assist_listening_phase_id};
                            then:
                              - lvgl.page.show: listening_page
                            else:
                              - if:
                                  condition:
                                    lambda: return id(voice_assistant_phase) == ${voice_assist_thinking_phase_id};
                                  then:
                                    - lvgl.page.show: thinking_page
                                  else:
                                    - if:
                                        condition:
                                          lambda: return id(voice_assistant_phase) == ${voice_assist_replying_phase_id};
                                        then:
                                          - lvgl.page.show: replying_page
                                        else:
                                          - if:
                                              condition:
                                                lambda: return id(voice_assistant_phase) == ${voice_assist_error_phase_id};
                                              then:
                                                - lvgl.page.show: error_page
                                              else:
                                                - if:
                                                    condition:
                                                      lambda: return id(voice_assistant_phase) == ${voice_assist_muted_phase_id};
                                                    then:
                                                      - lvgl.page.show: muted_page
                                                    else:
                                                      - if:
                                                          condition:
                                                            lambda: return id(voice_assistant_phase) == ${voice_assist_not_ready_phase_id};
                                                          then:
                                                            - lvgl.page.show: no_ha_page
                                                          else:
                                                            # Show the current screen based on screen index
                                                            - script.execute: navigate_to_screen
                      else:
                        - lvgl.page.show: no_ha_page
                else:
                  - lvgl.page.show: no_wifi_page
          else:
            - lvgl.page.show: initializing_page
      - script.execute: update_weather_dates

  - id: navigate_to_screen
    then:
      - if:
          condition:
            lambda: return !id(is_settings_open);
          then:
            - lambda: id(ignore_swipe) = false;
            - if:
                condition:
                  lambda: return id(current_screen_index) == 0;
                then:
                  - lvgl.page.show: main_screen
                else:
                  - if:
                      condition:
                        lambda: return id(current_screen_index) == 1;
                      then:
                        - lvgl.page.show: music_screen
                      else:
                        - lvgl.page.show: home_control_page

  - id: start_wake_word
    then:
      - if:
          condition:
            and:
              - not:
                  - voice_assistant.is_running:
              - lambda: return id(wake_word_engine_location).state == "On device";
          then:
            - lambda: id(va).set_use_wake_word(false);
            - micro_wake_word.start:
      - if:
          condition:
            and:
              - not:
                  - voice_assistant.is_running:
              - lambda: return id(wake_word_engine_location).state == "In Home Assistant";
          then:
            - lambda: id(va).set_use_wake_word(true);
            - voice_assistant.start_continuous:

  - id: stop_wake_word
    then:
      - if:
          condition:
            lambda: return id(wake_word_engine_location).state == "In Home Assistant";
          then:
            - lambda: id(va).set_use_wake_word(false);
            - voice_assistant.stop:
      - if:
          condition:
            lambda: return id(wake_word_engine_location).state == "On device";
          then:
            - micro_wake_word.stop:

  - id: set_idle_or_mute_phase
    then:
      - if:
          condition:
            switch.is_off: mute
          then:
            - lambda: id(voice_assistant_phase) = ${voice_assist_idle_phase_id};
          else:
            - lambda: id(voice_assistant_phase) = ${voice_assist_muted_phase_id};

  # Play radio station (deprecated - buttons now use direct action calls)
  # Kept for backward compatibility if used elsewhere
  - id: play_radio
    parameters:
      uri: string
      station_name: string
    then:
      - lambda: |-
          ESP_LOGI("radio", "Playing radio station: %s", station_name.c_str());
          id(current_radio_station) = station_name;
      # Call media_player.play_media service
      - homeassistant.action:
          action: media_player.play_media
          data:
            entity_id: ${default_media_player}
            media_content_id: !lambda "return uri;"
            media_content_type: ${album_radio_content_type}

  # Update the music image display based on radio mode or dynamic art
  - id: update_album_art_display
    then:
      - lvgl.image.update:
          id: music_image
          src: !lambda |-
            if (id(active_radio_station) == 1 || id(active_radio_station) == 7) {
              return id(radio_power_hit_large);
            } else if (id(active_radio_station) == 2 || id(active_radio_station) == 8) {
              return id(radio_european_hit_large);
            } else if (id(active_radio_station) == 3 || id(active_radio_station) == 9) {
              return id(radio_m1_large);
            } else if (id(active_radio_station) > 0) {
              // For 4, 5, 6 or others without specific logo defined in yaml
              return id(music_placeholder);
            } else {
              // Normal mode - dynamic album art
              return id(album_art_online);
            }
      - lvgl.image.update:
          id: music_image_full
          src: !lambda |-
            if (id(active_radio_station) == 1) {
              return id(radio_power_hit_large);
            } else if (id(active_radio_station) == 2) {
              return id(radio_european_hit_large);
            } else if (id(active_radio_station) == 3) {
              return id(radio_m1_large);
            } else if (id(active_radio_station) > 0) {
              return id(music_placeholder);
            } else {
              return id(album_art_online_full);
            }

  # Toggle play/pause
  - id: toggle_play_pause
    then:
      - if:
          condition:
            lambda: "return id(is_playing);"
          then:
            # Pause playback
            - lambda: |-
                ESP_LOGI("media", "Pausing playback");
            - homeassistant.action:
                action: media_player.media_pause
                data:
                  entity_id: ${default_media_player}
          else:
            # Resume playback
            - lambda: |-
                ESP_LOGI("media", "Resuming playback");
            - homeassistant.action:
                action: media_player.media_play
                data:
                  entity_id: ${default_media_player}

  # Volume control
  - id: volume_up
    then:
      - homeassistant.action:
          action: media_player.volume_up
          data:
            entity_id: ${default_media_player}

  - id: volume_down
    then:
      - homeassistant.action:
          action: media_player.volume_down
          data:
            entity_id: ${default_media_player}

  - id: update_weather_dates
    then:
      - lvgl.label.update:
          id: tomorrow_day
          text: !lambda |-
            auto now = id(ha_time).now();
            if (!now.is_valid()) return std::string("--/--");
            return ESPTime::from_epoch_local(now.timestamp + 86400).strftime("%d/%m");
      - lvgl.label.update:
          id: after_tomorrow_day
          text: !lambda |-
            auto now = id(ha_time).now();
            if (!now.is_valid()) return std::string("--/--");
            return ESPTime::from_epoch_local(now.timestamp + 172800).strftime("%d/%m");

# Global Variables
globals:
  - id: init_in_progress
    type: bool
    restore_value: false
    initial_value: "true"
  - id: voice_assistant_phase
    type: int
    restore_value: false
    initial_value: ${voice_assist_not_ready_phase_id}
  - id: current_screen_index
    type: int
    restore_value: true
    initial_value: "0"
  - id: touch_start_x
    type: int
    restore_value: false
    initial_value: "0"
  - id: touch_start_y
    type: int
    restore_value: false
    initial_value: "0"
  - id: swipe_in_progress
    type: bool
    restore_value: false
    initial_value: "false"
  - id: is_playing
    type: bool
    restore_value: true
    initial_value: "false"
  - id: current_radio_station
    type: std::string
    restore_value: true
    initial_value: '""'
  - id: active_radio_station
    type: int
    restore_value: false
    initial_value: "0"
  - id: long_press_detected
    type: bool
    restore_value: false
    initial_value: "false"
  - id: was_swipe
    type: bool
    restore_value: false
    initial_value: "false"
  - id: va_stt_text
    type: std::string
    restore_value: false
    initial_value: '""'
  - id: va_tts_text
    type: std::string
    restore_value: false
    initial_value: '""'
  - id: previous_screen_index
    type: int
    restore_value: false
    initial_value: "0"
  - id: is_settings_open
    type: bool
    restore_value: false
    initial_value: "false"
  - id: ignore_swipe
    type: bool
    restore_value: false
    initial_value: "false"

# Fonts for LVGL (based on screens.c design)
font:
  - file: "gfonts://Montserrat"
    id: font_montserrat_18
    size: 18
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "gfonts://Montserrat"
    id: font_montserrat_26
    size: 26
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "gfonts://Montserrat"
    id: font_montserrat_36
    size: 36
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "gfonts://Roboto@700"
    id: Roboto_64
    size: 64
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "gfonts://Roboto@700"
    id: Roboto_96
    size: 96
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "gfonts://Roboto@700"
    id: Roboto_128
    size: 128
    glyphs: " !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~¡¢£¤¥¦§¨©ª«¬®¯°±²³´µ¶·¸¹º»¼½¾¿ÀÁÂÃÄÅÆÇÈÉÊËÌÍÎÏÐÑÒÓÔÕÖ×ØÙÚÛÜÝÞßàáâãäåæçèéêëìíîïðñòóôõö÷øùúûüýþÿĀāĂăĄąĆćĈĉĊċČčĎďĐđĒēĔĕĖėĘęĚěĜĝĞğĠġĢģĤĥĦħĨĩĪīĬĭĮįİıĲĳĴĵĶķĸĹĺĻļĽľĿŀŁłŃńŅņŇňŉŊŋŌōŎŏŐőŒœŔŕŖŗŘřŚśŜŝŞşŠšŢţŤťŦŧŨũŪūŬŭŮůŰűŲųŴŵŶŷŸŹźŻżŽžſȘșȚț’…"

  - file: "https://github.com/Templarian/MaterialDesign-Webfont/raw/v7.4.47/fonts/materialdesignicons-webfont.ttf"
    id: mdi_80
    size: 80
    glyphs:
      - "\U000F0374" # mdi-minus
      - "\U000F03E4" # mdi-pause
      - "\U000F040A" # mdi-play
      - "\U000F0415" # mdi-plus
      - "\U000F04AD" # mdi-skip-next
      - "\U000F04AE" # mdi-skip-previous
      - "\U000f057f" # mdi:volume-low
      - "\U000F057E" # mdi-volume-high
      - "\U000F0D19" # mdi-play-box-multiple (for album/radio button)
      - "\U000F0335" # mdi-lightbulb
      - "\U000f03a5" # mdi-numeric-1-box-multiple
      - "\U000f03a8" # mdi-numeric-2-box-multiple
      - "\U000f03ab" # mdi-numeric-3-box-multiple

# Weather icon images (96x96)
image:
  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/sunny.png"
    id: weather_sunny
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/clear-night.png"
    id: weather_clear_night
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/cloudy.png"
    id: weather_cloudy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/fog.png"
    id: weather_fog
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/hail.png"
    id: weather_hail
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/lightning.png"
    id: weather_lightning
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/lightning-rainy.png"
    id: weather_lightning_rainy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/partlycloudyday.png"
    id: weather_partlycloudyday
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/partlycloudynight.png"
    id: weather_partlycloudynight
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/pouring.png"
    id: weather_pouring
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/rainy.png"
    id: weather_rainy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/snowy-rainy.png"
    id: weather_snowy_rainy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/snowy.png"
    id: weather_snowy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/windy.png"
    id: weather_windy
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/windy-variant.png"
    id: weather_windy_variant
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/weather-icons/96x96/exceptional.png"
    id: weather_exceptional
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  # Music player placeholder image (250x250)
  - file: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Youtube_Music_icon.svg/250px-Youtube_Music_icon.svg.png"
    id: music_placeholder
    resize: 250x250
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  # Radio station logos (96x96) - For Buttons
  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/power-hit-radio.png"
    id: radio_power_hit
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/european-hit-radio.png"
    id: radio_european_hit
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/m1-plius-radio.png"
    id: radio_m1
    resize: 96x96
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  # Radio station logos (250x250) - For Music Player Screen
  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/power-hit-radio.png"
    id: radio_power_hit_large
    resize: 250x250
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/european-hit-radio.png"
    id: radio_european_hit_large
    resize: 250x250
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

  - file: "https://raw.githubusercontent.com/Skirmantas-SK/esphome-projects/main/esp32-p4-86-panel/resources/playlist-radio-icons/m1-plius-radio.png"
    id: radio_m1_large
    resize: 250x250
    type: RGB565
    transparency: alpha_channel
    byte_order: little_endian

# Dynamic Album Art - Online Image Component
# This image automatically downloads and displays album art from URLs
online_image:
  - url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Youtube_Music_icon.svg/250px-Youtube_Music_icon.svg.png"
    id: album_art_online
    format: JPEG # CRITICAL: Changed from PNG because Music Assistant usually provides JPEGs
    resize: 250x250
    type: RGB565
    byte_order: little_endian
    placeholder: music_placeholder
    update_interval: never # Only update when explicitly triggered
    on_download_finished:
      # CRITICAL: Trigger LVGL update when download completes
      - if:
          condition:
            lambda: return id(active_radio_station) == 0;
          then:
            - lvgl.image.update:
                id: music_image
                src: album_art_online

  - url: "https://upload.wikimedia.org/wikipedia/commons/thumb/6/6a/Youtube_Music_icon.svg/250px-Youtube_Music_icon.svg.png"
    id: album_art_online_full
    format: JPEG
    resize: 720x720
    type: RGB565
    byte_order: little_endian
    placeholder: music_placeholder
    update_interval: never
    on_download_finished:
      - if:
          condition:
            lambda: return id(active_radio_station) == 0;
          then:
            - lvgl.image.update:
                id: music_image_full
                src: album_art_online_full

# LVGL Configuration
lvgl:
  log_level: WARN
  displays:
    - main_display
  touchscreens:
    - touchscreen_controller

  color_depth: 16
  bg_color: 0x000000
  text_color: 0xFFFFFF
  buffer_size: 100%
  byte_order: little_endian

  default_font: font_montserrat_18

  theme:
    obj:
      bg_color: 0x000000
      radius: 50

  pages:
    ###########################################################################
    # MAIN SCREEN - Weather and Control Screen (based on create_screen_main)
    ###########################################################################
    - id: main_screen
      bg_color: 0x000000
      widgets:
        - obj: # Main container
            id: main_container
            width: 720
            height: 720
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
            scrollable: false
            widgets:
              # Current time (top center)
              - label:
                  id: current_time
                  text: "20:22"
                  x: 360
                  y: 29
                  text_font: Roboto_128
                  text_color: 0xFFFFFF
                  text_align: CENTER

              # Current temperature (top left)
              - label:
                  id: current_temp
                  text: "20°"
                  align: TOP_MID
                  x: -250
                  y: 63
                  text_font: Roboto_64
                  text_color: 0xFFFFFF
                  text_align: CENTER

              # Current weather icon (top, left of time)
              - image:
                  id: current_weather_icon
                  src: weather_sunny
                  x: 155
                  y: 50
                  width: 96
                  height: 96

              # Horizontal line separator (below time)
              - obj:
                  x: 20
                  y: 185
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Today's weather card (left)
              - obj:
                  id: todays_weather
                  x: 16
                  y: 195
                  width: 260
                  height: 330
                  bg_color: 0x1a1a1a
                  bg_opa: 100%
                  radius: 50
                  border_width: 0
                  scrollable: false
                  widgets:
                    - label:
                        id: today_label
                        text: "Today"
                        x: 71
                        y: 20
                        text_font: font_montserrat_36
                        text_color: 0xFFFFFF

                    - obj: # Line below "Today"
                        x: 50
                        y: 70
                        width: 150
                        height: 1
                        bg_color: 0xFFFFFF

                    - label:
                        id: current_temp_weather
                        text: "20°"
                        align: TOP_MID
                        x: -45
                        y: 110
                        text_font: Roboto_64
                        text_color: 0xFFFFFF
                        text_align: CENTER

                    - image:
                        id: todays_weather_icon
                        src: weather_sunny
                        x: 135
                        y: 96
                        width: 96
                        height: 96

                    - label:
                        id: wind_label
                        text: "Wind"
                        x: 38
                        y: 208
                        text_color: 0xFFFFFF

                    - label:
                        id: wind_value
                        text: "10.0 m/s"
                        x: 30
                        y: 229
                        text_color: 0xFFFFFF

                    - label:
                        id: humidity_label
                        text: "Humidity"
                        x: 25
                        y: 267
                        text_color: 0xFFFFFF

                    - label:
                        id: humidity_value
                        text: "60%"
                        x: 48
                        y: 292
                        text_color: 0xFFFFFF

                    - label:
                        id: highest_label
                        text: "Highest"
                        x: 144
                        y: 208
                        text_color: 0xFFFFFF

                    - label:
                        id: highest_value
                        text: "23°"
                        x: 168
                        y: 230
                        text_color: 0xFFFFFF

                    - label:
                        id: lowest_label
                        text: "Lowest"
                        x: 147
                        y: 267
                        text_color: 0xFFFFFF

                    - label:
                        id: lowest_value
                        text: "16°"
                        x: 170
                        y: 292
                        text_color: 0xFFFFFF

              # Tomorrow's weather card (middle)
              - obj:
                  id: tomorrows_weather
                  x: 291
                  y: 195
                  width: 140
                  height: 330
                  bg_color: 0x1a1a1a
                  bg_opa: 100%
                  radius: 50
                  border_width: 0
                  scrollable: false
                  widgets:
                    - label:
                        id: tomorrow_day
                        text: "--/--"
                        align: TOP_MID
                        x: 0
                        y: 20
                        text_font: font_montserrat_36
                        text_color: 0xFFFFFF

                    - obj: # Line
                        x: 18
                        y: 70
                        width: 80
                        height: 1
                        bg_color: 0xFFFFFF

                    - image:
                        id: tomorrows_weather_icon
                        src: weather_sunny
                        x: 10
                        y: 96
                        width: 96
                        height: 96

                    - label:
                        id: tomorrow_temp
                        text: "23°"
                        align: TOP_MID
                        x: 10
                        y: 224
                        text_font: Roboto_64
                        text_color: 0xFFFFFF
                        text_align: CENTER

              # After tomorrow's weather card (right)
              - obj:
                  id: after_tomorrows_weather
                  x: 446
                  y: 195
                  width: 140
                  height: 330
                  bg_color: 0x1a1a1a
                  bg_opa: 100%
                  radius: 50
                  border_width: 0
                  scrollable: false
                  widgets:
                    - label:
                        id: after_tomorrow_day
                        text: "--/--"
                        align: TOP_MID
                        x: 0
                        y: 20
                        text_font: font_montserrat_36
                        text_color: 0xFFFFFF

                    - obj: # Line
                        x: 18
                        y: 70
                        width: 80
                        height: 1
                        bg_color: 0xFFFFFF

                    - image:
                        id: after_tomorrows_weather_icon
                        src: weather_sunny
                        x: 10
                        y: 96
                        width: 96
                        height: 96

                    - label:
                        id: after_tomorrow_temp
                        text: "20°"
                        align: TOP_MID
                        x: 10
                        y: 224
                        text_font: Roboto_64
                        text_color: 0xFFFFFF
                        text_align: CENTER

              # Vertical line separator (right side)
              - obj:
                  x: 599
                  y: 200
                  width: 1
                  height: 320
                  bg_color: 0xFFFFFF

              # Radio buttons 
              - button:
                  id: radio_1
                  x: 609
                  y: 195
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 1;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_1_content_id}
                  widgets:
                    - image:
                        src: radio_power_hit
                        align: CENTER

              - button:
                  id: radio_2
                  x: 609
                  y: 312
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 2;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_2_content_id}
                  widgets:
                    - image:
                        src: radio_european_hit
                        align: CENTER

              - button:
                  id: radio_3
                  x: 609
                  y: 429
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 3;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_3_content_id}
                  widgets:
                    - image:
                        src: radio_m1
                        align: CENTER

              # Horizontal line separator (above controls)
              - obj:
                  x: 20
                  y: 535
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Volume controls and pause button
              - button:
                  id: volume_low
                  x: 16
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_down
                  widgets:
                    - label:
                        text: "\U000f057f" # mdi:volume-low
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: pause_button
                  x: 291
                  y: 545
                  width: 140
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_press:
                    - lambda: id(long_press_detected) = false;
                  on_long_press:
                    - lambda: id(long_press_detected) = true;
                    - homeassistant.action:
                        action: media_player.media_next_track
                        data:
                          entity_id: ${default_media_player}
                  on_click:
                    - if:
                        condition:
                          lambda: return !id(long_press_detected);
                        then:
                          - script.execute: toggle_play_pause
                  widgets:
                    - label:
                        id: pause_button_label
                        text: "\U000F040A" # mdi:play (default)
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: volume_high
                  x: 446
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_up
                  widgets:
                    - label:
                        text: "\U000F057E" # mdi:volume-high
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              # Page indicator dots (bottom center)
              - obj:
                  id: dots_main
                  y: 320
                  width: 180
                  height: 60
                  bg_opa: 0%
                  border_width: 0
                  scrollable: false
                  align: CENTER
                  widgets:
                    - button:
                        id: dot_1_main
                        x: 0
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0xFFFFFF # Active
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: main_screen

                    - button:
                        id: dot_2_main
                        x: 60
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: music_screen

                    - button:
                        id: dot_3_main
                        x: 120
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: home_control_page

              # Corner sensor dots
              - button:
                  x: 5
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 5
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

    ###########################################################################
    # MUSIC SCREEN - Media Player Screen (based on create_screen_music)
    ###########################################################################
    - id: music_screen
      bg_color: 0x000000
      widgets:
        - obj: # Main container
            id: music_container
            width: 720
            height: 720
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
            scrollable: false
            widgets:
              # Current time (top center)
              - label:
                  id: current_time_music
                  text: "20:22"
                  x: 360
                  y: 29
                  text_font: Roboto_128
                  text_color: 0xFFFFFF
                  text_align: CENTER

              # Current temperature (top left)
              - label:
                  id: current_temp_music
                  text: "20°"
                  align: TOP_MID
                  x: -250
                  y: 63
                  text_font: Roboto_64
                  text_color: 0xFFFFFF
                  text_align: CENTER

              # Current weather icon (top, left of time)
              - image:
                  id: current_weather_icon_music
                  src: weather_sunny
                  x: 155
                  y: 50
                  width: 96
                  height: 96

              # Horizontal line separator (below time)
              - obj:
                  x: 20
                  y: 185
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Vertical line separator (left side)
              - obj:
                  x: 121
                  y: 200
                  width: 1
                  height: 320
                  bg_color: 0xFFFFFF

              # Vertical line separator (right side)
              - obj:
                  x: 599
                  y: 200
                  width: 1
                  height: 320
                  bg_color: 0xFFFFFF

              # Playlist buttons (Left side)
              - button:
                  id: playlist_1_music
                  x: 16
                  y: 195
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 4;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${playlist_content_type}
                          media_content_id: ${playlist_1_content_id}
                  widgets:
                    - label:
                        text: "\U000f03a5" # mdi:numeric-1-box-multiple
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: playlist_2_music
                  x: 16
                  y: 312
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 5;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${playlist_content_type}
                          media_content_id: ${playlist_2_content_id}
                  widgets:
                    - label:
                        text: "\U000f03a8" # mdi:numeric-2-box-multiple
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: playlist_3_music
                  x: 16
                  y: 429
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 6;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${playlist_content_type}
                          media_content_id: ${playlist_3_content_id}
                  widgets:
                    - label:
                        text: "\U000f03ab" # mdi:numeric-3-box-multiple
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              # Right side radio buttons
              - button:
                  id: radio_1_music
                  x: 609
                  y: 195
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 1;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_1_content_id}
                  widgets:
                    - image:
                         src: radio_power_hit
                         align: CENTER

              - button:
                  id: radio_2_music
                  x: 609
                  y: 312
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 2;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_2_content_id}
                  widgets:
                    - image:
                         src: radio_european_hit
                         align: CENTER

              - button:
                  id: radio_3_music
                  x: 609
                  y: 429
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 3;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_3_content_id}
                  widgets:
                    - image:
                         src: radio_m1
                         align: CENTER

              # Album art / Music image (center)
              # Uses online_image component for dynamic album art from URLs
              - image:
                  id: music_image
                  src: album_art_online
                  x: 235 # (720 - 250) / 2 = 235. Centered exactly.
                  y: 200
                  width: 250
                  height: 250
                  clickable: true
                  on_click:
                    - if:
                        condition:
                          lambda: return !id(was_swipe);
                        then:
                          - lvgl.page.show: music_full_screen_page

              # Music title
              - label:
                  id: music_title
                  text: "Song"
                  align: TOP_MID
                  x: 0
                  y: 463
                  width: 460
                  text_font: font_montserrat_26
                  text_color: 0xFFFFFF
                  text_align: CENTER
                  long_mode: SCROLL_CIRCULAR

              # Music artist
              - label:
                  id: music_artist
                  text: "Artist"
                  align: TOP_MID
                  x: 0
                  y: 504
                  width: 460
                  text_font: font_montserrat_18
                  text_color: 0xFFFFFF
                  text_align: CENTER
                  long_mode: SCROLL_CIRCULAR

              # Horizontal line separator (above controls)
              - obj:
                  x: 20
                  y: 535
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Volume controls and pause button
              - button:
                  id: volume_low_music
                  x: 16
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_down
                  widgets:
                    - label:
                        text: "\U000f057f" # mdi:volume-low
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: pause_button_music
                  x: 291
                  y: 545
                  width: 140
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_press:
                    - lambda: id(long_press_detected) = false;
                  on_long_press:
                    - lambda: id(long_press_detected) = true;
                    - homeassistant.action:
                        action: media_player.media_next_track
                        data:
                          entity_id: ${default_media_player}
                  on_click:
                    - if:
                        condition:
                          lambda: return !id(long_press_detected);
                        then:
                          - script.execute: toggle_play_pause
                  widgets:
                    - label:
                        id: pause_button_music_label
                        text: "\U000F040A" # mdi:play (default)
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: volume_high_music
                  x: 446
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_up
                  widgets:
                    - label:
                        text: "\U000F057E" # mdi:volume-high
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              # Page indicator dots (bottom center)
              - obj:
                  id: dots_music
                  y: 320
                  width: 180
                  height: 60
                  bg_opa: 0%
                  border_width: 0
                  scrollable: false
                  align: CENTER
                  widgets:
                    - button:
                        id: dot_1_music
                        x: 0
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: main_screen

                    - button:
                        id: dot_2_music
                        x: 60
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0xFFFFFF # Active
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: music_screen

                    - button:
                        id: dot_3_music
                        x: 120
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: home_control_page

              # Corner sensor dots
              - button:
                  x: 5
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 5
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

    ###########################################################################
    # HOME CONTROL PAGE 
    ###########################################################################
    - id: home_control_page
      bg_color: 0x000000
      widgets:
        - obj: # Main container
            id: home_control_container
            width: 720
            height: 720
            bg_color: 0x000000
            border_width: 0
            pad_all: 0
            scrollable: false
            widgets:
              # Header (Time/Temp/Weather) - Reused layout
              - label:
                  id: current_time_home
                  text: "20:22"
                  x: 360
                  y: 29
                  text_font: Roboto_128
                  text_color: 0xFFFFFF
                  text_align: CENTER

              - label:
                  id: current_temp_home
                  text: "20°"
                  align: TOP_MID
                  x: -250
                  y: 63
                  text_font: Roboto_64
                  text_color: 0xFFFFFF
                  text_align: CENTER

              - image:
                  id: current_weather_icon_home
                  src: weather_sunny
                  x: 155
                  y: 50
                  width: 96
                  height: 96

              # Horizontal line separator (below time)
              - obj:
                  x: 20
                  y: 185
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Horizontal line separator (above controls)
              - obj:
                  x: 20
                  y: 535
                  width: 680
                  height: 1
                  bg_color: 0xFFFFFF

              # Vertical line separator (right side)
              - obj:
                  x: 599
                  y: 200
                  width: 1
                  height: 320
                  bg_color: 0xFFFFFF

              # Right side radio buttons
              - button:
                  id: radio_1_home
                  x: 609
                  y: 195
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 1;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_1_content_id}
                  widgets:
                    - image:
                        src: radio_power_hit
                        align: CENTER

              - button:
                  id: radio_2_home
                  x: 609
                  y: 312
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 2;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_2_content_id}
                  widgets:
                    - image:
                        src: radio_european_hit
                        align: CENTER

              - button:
                  id: radio_3_home
                  x: 609
                  y: 429
                  width: 96
                  height: 96
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - lambda: id(active_radio_station) = 3;
                    - script.execute: update_album_art_display
                    - homeassistant.action:
                        action: media_player.play_media
                        data:
                          entity_id: ${default_media_player}
                          media_content_type: ${album_radio_content_type}
                          media_content_id: ${radio_3_content_id}
                  widgets:
                    - image:
                        src: radio_m1
                        align: CENTER

              # Volume controls and pause button
              - button:
                  id: volume_low_home
                  x: 16
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_down
                  widgets:
                    - label:
                        text: "\U000f057f" # mdi:volume-low
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: pause_button_home
                  x: 291
                  y: 545
                  width: 140
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_press:
                    - lambda: id(long_press_detected) = false;
                  on_long_press:
                    - lambda: id(long_press_detected) = true;
                    - homeassistant.action:
                        action: media_player.media_next_track
                        data:
                          entity_id: ${default_media_player}
                  on_click:
                    - if:
                        condition:
                          lambda: return !id(long_press_detected);
                        then:
                          - script.execute: toggle_play_pause
                  widgets:
                    - label:
                        id: pause_button_home_label
                        text: "\U000F040A" # mdi:play (default)
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER
              - button:
                  id: volume_high_home
                  x: 446
                  y: 545
                  width: 260
                  height: 100
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - script.execute: volume_up
                  widgets:
                    - label:
                        text: "\U000F057E" # mdi:volume-high
                        text_color: 0xFFFFFF
                        text_font: mdi_80
                        align: CENTER

              - button:
                  id: button_1
                  x: 16
                  y: 197
                  width: 275
                  height: 156
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - homeassistant.service:
                        service: homeassistant.toggle
                        data:
                          entity_id: ${button_1_entity}
                  widgets:
                    - label:
                        text: "Button 1"
                        text_color: 0xFFFFFF
                        text_font: Roboto_64
                        align: CENTER

              - button:
                  id: button_2
                  x: 306
                  y: 197
                  width: 275
                  height: 156
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - homeassistant.service:
                        service: homeassistant.toggle
                        data:
                          entity_id: ${button_2_entity}
                  widgets:
                    - label:
                        text: "Button 2"
                        text_color: 0xFFFFFF
                        text_font: Roboto_64
                        align: CENTER

              - button:
                  id: button_3
                  x: 16
                  y: 367
                  width: 275
                  height: 156
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - homeassistant.service:
                        service: homeassistant.toggle
                        data:
                          entity_id: ${button_3_entity}
                  widgets:
                    - label:
                        text: "Button 3"
                        text_color: 0xFFFFFF
                        text_font: Roboto_64
                        align: CENTER

              - button:
                  id: button_4
                  x: 306
                  y: 367
                  width: 275
                  height: 156
                  bg_color: 0x1a1a1a
                  shadow_opa: 0
                  radius: 30
                  on_click:
                    - homeassistant.service:
                        service: homeassistant.toggle
                        data:
                          entity_id: ${button_4_entity}
                  widgets:
                    - label:
                        text: "Button 4"
                        text_color: 0xFFFFFF
                        text_font: Roboto_64
                        align: CENTER
              
              # Page indicator dots
              - obj:
                  id: dots_home
                  y: 320
                  width: 180
                  height: 60
                  bg_opa: 0%
                  border_width: 0
                  scrollable: false
                  align: CENTER
                  widgets:
                    - button:
                        id: dot_1_home
                        x: 0
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: main_screen

                    - button:
                        id: dot_2_home
                        x: 60
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0x1a1a1a # Inactive
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: music_screen

                    - button:
                        id: dot_3_home
                        x: 120
                        y: 0
                        width: 40
                        height: 40
                        bg_color: 0xFFFFFF # Active
                        shadow_opa: 0
                        radius: 50
                        on_click:
                          - lvgl.page.show: home_control_page

              # Corner sensor dots
              - button:
                  x: 5
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 5
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 5
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

              - button:
                  x: 705
                  y: 705
                  width: 10
                  height: 10
                  bg_color: 0xFFFFFF
                  shadow_opa: 0
                  radius: 50

    ###########################################################################
    # SETTINGS PAGE (Swipe Down)
    ###########################################################################
    - id: settings_page
      bg_color: 0x111111
      widgets:
        - obj:
            id: settings_container
            width: 720
            height: 720
            bg_color: 0x111111
            border_width: 0
            pad_all: 20
            scrollable: false
            widgets:
              - label:
                  text: "Settings"
                  align: TOP_MID
                  y: 20
                  text_font: Roboto_64
                  text_color: 0xFFFFFF

              # Brightness Control
              - label:
                  text: "Brightness"
                  x: 20
                  y: 120
                  text_font: font_montserrat_26
                  text_color: 0xAAAAAA

              - slider:
                  id: slider_brightness
                  x: 20
                  y: 160
                  width: 620
                  height: 40
                  min_value: 10
                  max_value: 100
                  value: 100 # Default, should sync with actual state if possible
                  on_press:
                    - lambda: |-
                        id(ignore_swipe) = true;
                        id(swipe_in_progress) = false;
                  on_release:
                    - delay: 50ms
                    - lambda: id(ignore_swipe) = false;
                  on_value:
                    - lambda: |-
                        if (!id(ignore_swipe)) return;
                        float val = (float)lv_slider_get_value(id(slider_brightness)) / 100.0;
                        auto call = id(backlight_light).turn_on();
                        call.set_brightness(val);
                        call.perform();

              # Volume Control
              - label:
                  text: "Volume"
                  x: 20
                  y: 240
                  text_font: font_montserrat_26
                  text_color: 0xAAAAAA

              - slider:
                  id: slider_volume
                  x: 20
                  y: 280
                  width: 620
                  height: 40
                  min_value: 0
                  max_value: 100
                  value: 80 # Default
                  on_press:
                    - lambda: |-
                        id(ignore_swipe) = true;
                        id(swipe_in_progress) = false;
                  on_release:
                    - delay: 50ms
                    - lambda: id(ignore_swipe) = false;
                  on_value:
                    - lambda: |-
                        if (!id(ignore_swipe)) return;
                        id(external_media_player).make_call().set_volume((float)x / 100.0).perform();

              # Reboot Button
              - button:
                  id: btn_reboot
                  x: 20
                  y: 400
                  width: 300
                  height: 80
                  bg_color: 0xAA0000
                  shadow_opa: 0
                  radius: 20
                  on_click:
                    - lambda: id(restart_button).press();
                  widgets:
                    - label:
                        text: "Reboot Device"
                        align: CENTER
                        text_font: font_montserrat_26
                        text_color: 0xFFFFFF

              # Close Button (Bottom)
              - button:
                  id: btn_close_settings
                  align: BOTTOM_MID
                  y: -20
                  width: 200
                  height: 60
                  bg_color: 0x333333
                  shadow_opa: 0 
                  radius: 30
                  on_click:
                    - lambda: id(is_settings_open) = false;
                    - script.execute: navigate_to_screen
                  widgets:
                    - label:
                        text: "Close"
                        align: CENTER
                        text_font: font_montserrat_26
                        text_color: 0xFFFFFF

    ###########################################################################
    # FULL SCREEN MUSIC ART
    ###########################################################################
    - id: music_full_screen_page
      bg_color: 0x000000
      widgets:
        - image:
            id: music_image_full
            src: album_art_online_full
            width: 720
            height: 720
            align: CENTER
            clickable: true
            on_click:
              - if:
                  condition:
                    lambda: return !id(was_swipe);
                  then:
                    - lvgl.page.show: music_screen

    ###########################################################################
    # VOICE ASSISTANT PAGES
    ###########################################################################
    - id: listening_page
      bg_color: 0x0000FF
      widgets:
        - label:
            text: "Listening..."
            align: CENTER
            y: -50
            text_align: CENTER
            text_color: 0xFFFFFF
            text_font: Roboto_64
        # Simulated Waveform (Bars)
        - obj:
            id: wave_container
            width: 300
            height: 100
            align: CENTER
            y: 50
            bg_opa: 0%
            border_width: 0
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: SPACE_EVENLY
              flex_align_cross: CENTER
            widgets:
              - obj:
                  id: wave_1
                  width: 20
                  height: 20
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_2
                  width: 20
                  height: 40
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_3
                  width: 20
                  height: 60
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_4
                  width: 20
                  height: 40
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_5
                  width: 20
                  height: 20
                  bg_color: 0xFFFFFF
                  radius: 10

    - id: thinking_page
      bg_color: 0xFF8800
      widgets:
        - label:
            text: "Thinking..."
            align: CENTER
            y: -50
            text_align: CENTER
            text_color: 0xFFFFFF
            text_font: Roboto_64

    - id: replying_page
      bg_color: 0x00AA00
      widgets:
        - label:
            text: "Replying..."
            align: CENTER
            y: -50
            text_align: CENTER
            text_color: 0xFFFFFF
            text_font: Roboto_64
        # Simulated Waveform for Speaking
        - obj:
            id: wave_container_reply
            width: 300
            height: 100
            align: CENTER
            y: 50
            bg_opa: 0%
            border_width: 0
            layout:
              type: FLEX
              flex_flow: ROW
              flex_align_main: SPACE_EVENLY
              flex_align_cross: CENTER
            widgets:
              - obj:
                  id: wave_1_r
                  width: 20
                  height: 20
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_2_r
                  width: 20
                  height: 40
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_3_r
                  width: 20
                  height: 60
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_4_r
                  width: 20
                  height: 40
                  bg_color: 0xFFFFFF
                  radius: 10
              - obj:
                  id: wave_5_r
                  width: 20
                  height: 20
                  bg_color: 0xFFFFFF
                  radius: 10

    - id: error_page
      bg_color: 0xFF0000
      widgets:
        - label:
            text: "Error"
            align: TOP_MID
            y: 150
            text_align: CENTER
            text_color: 0xFFFFFF
            text_font: Roboto_96

    - id: no_ha_page
      bg_color: 0x660000
      widgets:
        - obj:
            width: 720
            height: 720
            bg_color: 0x660000
            border_width: 0
            widgets:
              - label:
                  text: "No Home Assistant"
                  align: CENTER
                  y: -30
                  text_align: CENTER
                  text_color: 0xFFFFFF
                  text_font: Roboto_64
              - label:
                  text: "Check connection"
                  align: CENTER
                  y: 30
                  text_align: CENTER
                  text_color: 0xFFFFFF
                  text_font: font_montserrat_36

    - id: no_wifi_page
      bg_color: 0x666600
      widgets:
        - obj:
            width: 720
            height: 720
            bg_color: 0x666600
            border_width: 0
            widgets:
              - label:
                  text: "No WiFi"
                  align: CENTER
                  y: -30
                  text_align: CENTER
                  text_color: 0xFFFFFF
                  text_font: Roboto_96
              - label:
                  text: "Connecting..."
                  align: CENTER
                  y: 60
                  text_align: CENTER
                  text_color: 0xFFFFFF
                  text_font: Roboto_64

    - id: initializing_page
      bg_color: 0x333333
      widgets:
        - label:
            text: "Initializing..."
            align: CENTER
            text_align: CENTER
            text_color: 0xFFFFFF
            text_font: Roboto_96

    - id: muted_page
      bg_color: 0x000000
      widgets:
        - label:
            text: "Muted"
            align: CENTER
            text_align: CENTER
            text_color: 0xFF0000
            text_font: Roboto_96

# Update time display every second
interval:
  - interval: 1s
    then:
      - lvgl.label.update:
          id: current_time
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) {
              return std::string("--:--");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%02d:%02d", time.hour, time.minute);
            return std::string(buf);
  - interval: 1s
    then:
      - lvgl.label.update:
          id: current_time_music
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) {
              return std::string("--:--");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%02d:%02d", time.hour, time.minute);
            return std::string(buf);
  - interval: 1s
    then:
      - lvgl.label.update:
          id: current_time_home
          text: !lambda |-
            auto time = id(ha_time).now();
            if (!time.is_valid()) {
              return std::string("--:--");
            }
            char buf[20];
            snprintf(buf, sizeof(buf), "%02d:%02d", time.hour, time.minute);
            return std::string(buf);

  # Waveform Animation
  - interval: 100ms
    then:
      - lambda: |-
          if (id(voice_assistant_phase) == ${voice_assist_listening_phase_id}) {
             lv_obj_set_height(id(wave_1), rand() % 60 + 20);
             lv_obj_set_height(id(wave_2), rand() % 60 + 20);
             lv_obj_set_height(id(wave_3), rand() % 60 + 20);
             lv_obj_set_height(id(wave_4), rand() % 60 + 20);
             lv_obj_set_height(id(wave_5), rand() % 60 + 20);
          } else if (id(voice_assistant_phase) == ${voice_assist_replying_phase_id}) {
             lv_obj_set_height(id(wave_1_r), rand() % 60 + 20);
             lv_obj_set_height(id(wave_2_r), rand() % 60 + 20);
             lv_obj_set_height(id(wave_3_r), rand() % 60 + 20);
             lv_obj_set_height(id(wave_4_r), rand() % 60 + 20);
             lv_obj_set_height(id(wave_5_r), rand() % 60 + 20);
          }